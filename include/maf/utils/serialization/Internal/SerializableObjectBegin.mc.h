// NO INCLUDE GUARD

// clang-format off
#    ifdef mc_maf_choose_correct_default_value_macro
#        pragma push_macro("mc_maf_choose_correct_default_value_macro")
#        define maf_restore_macro_mc_maf_choose_correct_default_value_macro
#    endif
#    ifdef mc_maf_declare_get_set_func
#        pragma push_macro("mc_maf_declare_get_set_func")
#        define maf_restore_macro_mc_maf_declare_get_set_func
#    endif
#    ifdef mc_maf_declare_get_set_funcs_
#        pragma push_macro("mc_maf_declare_get_set_funcs_")
#        define maf_restore_macro_mc_maf_declare_get_set_funcs_
#    endif
#    ifdef mc_maf_declare_get_set_funcs_with_index
#        pragma push_macro("mc_maf_declare_get_set_funcs_with_index")
#        define maf_restore_macro_mc_maf_declare_get_set_funcs_with_index
#    endif
#    ifdef mc_maf_define_constructors_
#        pragma push_macro("mc_maf_define_constructors_")
#        define maf_restore_macro_mc_maf_define_constructors_
#    endif
#    ifdef mc_maf_define_dump_function
#        pragma push_macro("mc_maf_define_dump_function")
#        define maf_restore_macro_mc_maf_define_dump_function
#    endif
#    ifdef mc_maf_define_dump_helper_func
#        pragma push_macro("mc_maf_define_dump_helper_func")
#        define maf_restore_macro_mc_maf_define_dump_helper_func
#    endif
#    ifdef mc_maf_define_load_from_json_functions
#        pragma push_macro("mc_maf_define_load_from_json_functions")
#        define maf_restore_macro_mc_maf_define_load_from_json_functions
#    endif
#    ifdef mc_maf_dump_each_property
#        pragma push_macro("mc_maf_dump_each_property")
#        define maf_restore_macro_mc_maf_dump_each_property
#    endif
#    ifdef mc_maf_dump_each_property_
#        pragma push_macro("mc_maf_dump_each_property_")
#        define maf_restore_macro_mc_maf_dump_each_property_
#    endif
#    ifdef mc_maf_dump_each_property_with_index
#        pragma push_macro("mc_maf_dump_each_property_with_index")
#        define maf_restore_macro_mc_maf_dump_each_property_with_index
#    endif
#    ifdef mc_maf_get_default_value
#        pragma push_macro("mc_maf_get_default_value")
#        define maf_restore_macro_mc_maf_get_default_value
#    endif
#    ifdef mc_maf_get_default_value_
#        pragma push_macro("mc_maf_get_default_value_")
#        define maf_restore_macro_mc_maf_get_default_value_
#    endif
#    ifdef mc_maf_get_nth_option
#        pragma push_macro("mc_maf_get_nth_option")
#        define maf_restore_macro_mc_maf_get_nth_option
#    endif
#    ifdef mc_maf_get_overload
#        pragma push_macro("mc_maf_get_overload")
#        define maf_restore_macro_mc_maf_get_overload
#    endif
#    ifdef mc_maf_has_default
#        pragma push_macro("mc_maf_has_default")
#        define maf_restore_macro_mc_maf_has_default
#    endif
#    ifdef mc_maf_load_from_json_each_property
#        pragma push_macro("mc_maf_load_from_json_each_property")
#        define maf_restore_macro_mc_maf_load_from_json_each_property
#    endif
#    ifdef mc_maf_load_json_on_each_property_
#        pragma push_macro("mc_maf_load_json_on_each_property_")
#        define maf_restore_macro_mc_maf_load_json_on_each_property_
#    endif
#    ifdef mc_maf_load_json_on_each_property_with_index
#        pragma push_macro("mc_maf_load_json_on_each_property_with_index")
#        define maf_restore_macro_mc_maf_load_json_on_each_property_with_index
#    endif
#    ifdef mc_maf_no_default
#        pragma push_macro("mc_maf_no_default")
#        define maf_restore_macro_mc_maf_no_default
#    endif
#    ifdef mc_maf_properties_map
#        pragma push_macro("mc_maf_properties_map")
#        define maf_restore_macro_mc_maf_properties_map
#    endif
#    ifdef mc_maf_take_2_first_params_param
#        pragma push_macro("mc_maf_take_2_first_params_param")
#        define maf_restore_macro_mc_maf_take_2_first_params_param
#    endif
#    ifdef mc_maf_take_2_first_params_param_
#        pragma push_macro("mc_maf_take_2_first_params_param_")
#        define maf_restore_macro_mc_maf_take_2_first_params_param_
#    endif
#    ifdef mc_maf_take_only_first_arg
#        pragma push_macro("mc_maf_take_only_first_arg")
#        define maf_restore_macro_mc_maf_take_only_first_arg
#    endif
#    ifdef mc_maf_take_only_first_arg_
#        pragma push_macro("mc_maf_take_only_first_arg_")
#        define maf_restore_macro_mc_maf_take_only_first_arg_
#    endif
#    ifdef mc_maf_take_only_first_arg__
#        pragma push_macro("mc_maf_take_only_first_arg__")
#        define maf_restore_macro_mc_maf_take_only_first_arg__
#    endif
#    ifdef mc_maf_tuple_like_object
#        pragma push_macro("mc_maf_tuple_like_object")
#        define maf_restore_macro_mc_maf_tuple_like_object
#    endif
#    ifdef mc_maf_tuple_like_object_
#        pragma push_macro("mc_maf_tuple_like_object_")
#        define maf_restore_macro_mc_maf_tuple_like_object_
#    endif
#    ifdef mc_maf_tuple_like_object_end
#        pragma push_macro("mc_maf_tuple_like_object_end")
#        define maf_restore_macro_mc_maf_tuple_like_object_end
#    endif
#    ifdef mc_maf_tuple_like_object_has_base_
#        pragma push_macro("mc_maf_tuple_like_object_has_base_")
#        define maf_restore_macro_mc_maf_tuple_like_object_has_base_
#    endif
#    ifdef mc_maf_tuple_like_object_has_base_end_
#        pragma push_macro("mc_maf_tuple_like_object_has_base_end_")
#        define maf_restore_macro_mc_maf_tuple_like_object_has_base_end_
#    endif
#    ifdef mc_maf_tuple_value_at
#        pragma push_macro("mc_maf_tuple_value_at")
#        define maf_restore_macro_mc_maf_tuple_value_at
#    endif
// clang-format on

#include <maf/utils/cppextension/Loop.mc.h>
#include <maf/utils/serialization/TuplizableTypeBase.h>

#ifndef MAF_DISABLE_JSON
#include <maf/utils/serialization/JsonTrait.h>
#endif

/// ----------------------------------------------------------------------------
/// ----------------------------Declare Serializable class
/// ----------------------------------------------------------------------------
/// ----------------------------------------------------------------------------
#define mc_maf_tuple_like_object_(ClassName)                          \
  struct ClassName : public maf::srz::TuplizableTypeBase<ClassName> { \
    mc_maf_define_constructors_(ClassName)

#define mc_maf_tuple_like_object_end(ClassName)              \
 public:                                                     \
  static std::shared_ptr<ClassName> create(data_type data) { \
    auto p = std::make_shared<ClassName>();                  \
    p->_data = std::move(data);                              \
    return p;                                                \
  }                                                          \
  static std::shared_ptr<ClassName> create() {               \
    return std::make_shared<ClassName>();                    \
  }                                                          \
  }                                                          \
  ;

#define mc_maf_tuple_like_object_has_base_(ClassName, BaseClassName) \
  struct ClassName : public maf::srz::TuplizableTypeBase<ClassName>, \
                     public BaseClassName {                          \
    static_assert(std::is_default_constructible_v<BaseClassName>,    \
                  "The class `" #BaseClassName                       \
                  "` which is specified as base of `" #ClassName     \
                  "` must be has default constructor");              \
    mc_maf_define_constructors_(ClassName)

#define mc_maf_tuple_like_object_has_base_end_(ClassName) \
  mc_maf_tuple_like_object_end(ClassName)

#define mc_maf_get_nth_option(_1, _2, option, ...) option
#define mc_maf_get_overload(...)                                             \
  mc_maf_msvc_expand_va_args(                                                \
      mc_maf_get_nth_option(__VA_ARGS__, mc_maf_tuple_like_object_has_base_, \
                            mc_maf_tuple_like_object_)(__VA_ARGS__))
#define mc_maf_tuple_like_object(...) mc_maf_get_overload(__VA_ARGS__)

/// ---------------------------------------------------------------------------------------------------------------------------------------
/// ----------------------------Declare std::tuple<...> for storing properties
/// of class----------------------------------------------------
/// ---------------------------------------------------------------------------------------------------------------------------------------
#define mc_maf_properties_map(...)                                             \
 public:                                                                       \
  using data_type = std::tuple<mc_remove_first_arg(                            \
      mc_maf_for_each(mc_maf_take_only_first_arg, __VA_ARGS__))>;              \
  mc_maf_for_each_idx(mc_maf_declare_get_set_funcs_with_index, __VA_ARGS__)    \
      mc_maf_msvc_expand_va_args(mc_maf_define_dump_function(__VA_ARGS__))     \
          mc_maf_msvc_expand_va_args(                                          \
              mc_maf_define_load_from_json_functions(__VA_ARGS__)) data_type & \
          tuple() {                                                            \
    return _data;                                                              \
  }                                                                            \
  const data_type &tuple() const { return _data; }                             \
                                                                               \
 private:                                                                      \
  static constexpr size_t __propertiesCount = std::tuple_size_v<data_type>;    \
  data_type _data = data_type{mc_remove_first_arg(                             \
      mc_maf_for_each(mc_maf_get_default_value, __VA_ARGS__))};                \
  mc_maf_define_dump_helper_func

#define mc_maf_take_2_first_params_param_(first, second, ...) /*(*/ \
  first, second                                               /*)*/
#define mc_maf_take_2_first_params_param(...) \
  mc_maf_msvc_expand_va_args(mc_maf_take_2_first_params_param_(__VA_ARGS__))

#define mc_maf_take_only_first_arg__(first, ...) /*(*/ , first /*)*/
#define mc_maf_take_only_first_arg_(...) \
  mc_maf_msvc_expand_va_args(mc_maf_take_only_first_arg__(__VA_ARGS__))
#define mc_maf_take_only_first_arg(firstsecond) \
  mc_maf_take_only_first_arg_(mc_strip_parentheses(firstsecond))

#define mc_maf_no_default(type, name) \
  , {}
#define mc_maf_has_default(type, name, TheDefaultValue) , TheDefaultValue
#define mc_maf_choose_correct_default_value_macro(_1, _2, candidate1, \
                                                  candidate, ...)     \
  candidate
#define mc_maf_get_default_value_(...)                                  \
  mc_maf_msvc_expand_va_args(mc_maf_choose_correct_default_value_macro( \
      __VA_ARGS__, mc_maf_has_default, mc_maf_no_default)(__VA_ARGS__))
#define mc_maf_get_default_value(SetOfParams) \
  mc_maf_get_default_value_(mc_strip_parentheses(SetOfParams))

/// ----------------------------------------------------------------------------
/// ----------------------------Macros to generate dump functions for class
/// ClassName------------------------------------------------------
/// ----------------------------------------------------------------------------

#ifndef MAF_DISABLE_DUMP

#define mc_maf_define_dump_helper_func                           \
  template <typename T>                                          \
  static void dump(const char *valName, const T &val, int level, \
                   std::string &strOut) {                        \
    strOut += maf::srz::getIndent(level, true);                  \
    maf::srz::dump(valName, level, strOut);                      \
    strOut += maf::srz::keyValueSeparator(level);                \
    maf::srz::dump(val, level, strOut);                          \
    strOut += ",";                                               \
  }

#define mc_maf_dump_each_property_(Type, Name, index) \
  dump(#Name, get_##Name(), maf::srz::nextLevel(level), strOut);

#define mc_maf_dump_each_property(...) \
  mc_maf_msvc_expand_va_args(mc_maf_dump_each_property_(__VA_ARGS__))

#define mc_maf_dump_each_property_with_index(TypeName, index) \
  mc_maf_dump_each_property(                                  \
      mc_maf_take_2_first_params_param(mc_strip_parentheses(TypeName)), index)

#define mc_maf_define_dump_function(...)                         \
  void dump(int level, std::string &strOut) const {              \
    strOut += maf::srz::getIndent(level) + "{";                  \
    mc_maf_for_each_idx(mc_maf_dump_each_property_with_index,    \
                        __VA_ARGS__) if (strOut.back() == ',') { \
      strOut.resize(strOut.size() - 1);                          \
    }                                                            \
    strOut += maf::srz::getIndent(level, true) + "}";            \
  }                                                              \
  std::string dump(int level = -1) const {                        \
    std::string output;                                          \
    dump(level, output);                                         \
    return output;                                               \
  }
#else
#define mc_maf_define_dump_helper_func
#define mc_maf_define_dump_function(...)                \
  void dump(int /*level*/, std::string &strOut) const { \
    strOut = "Object Dump is not supported";            \
  }                                                     \
  std::string dump(int /*level*/ = 0) const {           \
    return "Object Dump is not supported";              \
  }
#endif

/// ---------------------------------------------------------------------------------------------------------------------------------------
/// ----------------------------Generate get/set fucntions for each
/// property---------------------------------------------------------------
/// ---------------------------------------------------------------------------------------------------------------------------------------
#define mc_maf_declare_get_set_funcs_with_index(TypeName, index) \
  mc_maf_declare_get_set_func(                                   \
      mc_maf_take_2_first_params_param(mc_strip_parentheses(TypeName)), index)

#define mc_maf_declare_get_set_func(...) \
  mc_maf_msvc_expand_va_args(mc_maf_declare_get_set_funcs_(__VA_ARGS__))

#define mc_maf_tuple_value_at(index) std::get<__propertiesCount - index>(_data)
#define mc_maf_declare_get_set_funcs_(Type, Name, index)                       \
 public:                                                                       \
  void set_##Name(const Type &value__) { this->get_##Name() = value__; }       \
  void set_##Name(Type &&value__) { this->get_##Name() = std::move(value__); } \
  const Type &get_##Name() const { return mc_maf_tuple_value_at(index); }      \
  Type &get_##Name() { return mc_maf_tuple_value_at(index); }

/// ---------------------------------------------------------------------------------------------------------------------------------------
/// ----------------------------Macros to load data from json
/// ---------------------------------------------------------------------------
/// ---------------------------------------------------------------------------------------------------------------------------------------

#ifndef MAF_DISABLE_JSON
#define mc_maf_load_json_on_each_property_(Type, Name, index)   \
  auto &Name##__ = get_##Name();                                \
  if (TheJsonTrait::template has<Type>(jsonIn, #Name)) {        \
    Name##__ = TheJsonTrait::template get<Type>(jsonIn, #Name); \
  }

#define mc_maf_load_from_json_each_property(...) \
  mc_maf_msvc_expand_va_args(mc_maf_load_json_on_each_property_(__VA_ARGS__))

#define mc_maf_load_json_on_each_property_with_index(TypeName, index) \
  mc_maf_load_from_json_each_property(                                \
      mc_maf_take_2_first_params_param(mc_strip_parentheses(TypeName)), index)

#define mc_maf_define_load_from_json_functions(...)                       \
  template <                                                              \
      typename JsonType,                                                  \
      std::enable_if_t<maf::srz::is_maf_compatible_json<JsonType>::value, \
                       bool> = true>                                      \
  void load_from_json(const JsonType &jsonIn) {                           \
    using TheJsonTrait = maf::srz::JsonTrait<JsonType>;                   \
    mc_maf_for_each_idx(mc_maf_load_json_on_each_property_with_index,     \
                        __VA_ARGS__)                                      \
  }                                                                       \
  template <                                                              \
      typename JsonType,                                                  \
      std::enable_if_t<maf::srz::is_maf_compatible_json<JsonType>::value, \
                       bool> = true>                                      \
  void load_from_json(const std::string &json_string) {                   \
    using TheJsonTrait = maf::srz::JsonTrait<JsonType>;                   \
    load_from_json(TheJsonTrait::fromString(json_string));                \
  }
#else

#define mc_maf_define_load_from_json_functions(...)                       \
  template <                                                              \
      typename JsonType,                                                  \
      std::enable_if_t<maf::srz::is_maf_compatible_json<JsonType>::value, \
                       bool> = true>                                      \
  void load_from_json(const JsonType & /*jsonIn*/) {}                     \
  template <                                                              \
      typename JsonType,                                                  \
      std::enable_if_t<maf::srz::is_maf_compatible_json<JsonType>::value, \
                       bool> = true>                                      \
  void load_from_json(const std::string & /*json_string*/) {}
#endif

#define mc_maf_define_constructors_(ClassName)                                 \
  ClassName() = default;                                                       \
  ClassName(const ClassName &rhs) = default;                                   \
  ClassName(ClassName &&rhs) = default;                                        \
  ClassName &operator=(const ClassName &rhs) = default;                        \
  ClassName &operator=(ClassName &&rhs) = default;                             \
  template <typename... T>                                                     \
  ClassName(T... args) noexcept : _data(std::move(args)...) {}                 \
  friend bool operator==(const ClassName &lhs,                                 \
                         const ClassName &rhs) noexcept {                      \
    return rhs._data == lhs._data;                                             \
  }                                                                            \
  friend bool operator<=(const ClassName &lhs,                                 \
                         const ClassName &rhs) noexcept {                      \
    return rhs._data <= lhs._data;                                             \
  }                                                                            \
  friend bool operator>=(const ClassName &lhs,                                 \
                         const ClassName &rhs) noexcept {                      \
    return rhs._data >= lhs._data;                                             \
  }                                                                            \
  friend bool operator<(const ClassName &lhs, const ClassName &rhs) noexcept { \
    return rhs._data < lhs._data;                                              \
  }                                                                            \
  friend bool operator>(const ClassName &lhs, const ClassName &rhs) noexcept { \
    return rhs._data > lhs._data;                                              \
  }                                                                            \
  friend bool operator!=(const ClassName &lhs,                                 \
                         const ClassName &rhs) noexcept {                      \
    return rhs._data != lhs._data;                                             \
  }
